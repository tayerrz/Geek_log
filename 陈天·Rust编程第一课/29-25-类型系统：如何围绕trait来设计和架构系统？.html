<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>Traitï¼Œtraitï¼Œtraitï¼Œæ€ä¹ˆåˆæ˜¯ traitï¼Ÿhow old are you?</p><p>å¸Œæœ›ä½ è¿˜æ²¡æœ‰åŒå€¦æˆ‘ä»¬æ²¡å®Œæ²¡äº†åœ°èŠå…³äº trait çš„è¯é¢˜ã€‚å› ä¸º trait åœ¨ Rust å¼€å‘ä¸­çš„åœ°ä½ï¼Œæ€ä¹ˆå¹éƒ½ä¸ä¸ºè¿‡ã€‚</p><p>å…¶å®ä¸å…‰æ˜¯ Rust ä¸­çš„ traitï¼Œä»»ä½•ä¸€é—¨è¯­è¨€ï¼Œå’Œæ¥å£å¤„ç†ç›¸å…³çš„æ¦‚å¿µï¼Œéƒ½æ˜¯é‚£é—¨è¯­è¨€åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æœ€é‡è¦çš„æ¦‚å¿µã€‚<strong>è½¯ä»¶å¼€å‘çš„æ•´ä¸ªè¡Œä¸ºï¼ŒåŸºæœ¬ä¸Šå¯ä»¥è¯´æ˜¯ä¸æ–­åˆ›å»ºå’Œè¿­ä»£æ¥å£ï¼Œç„¶ååœ¨è¿™äº›æ¥å£ä¸Šè¿›è¡Œå®ç°çš„è¿‡ç¨‹</strong>ã€‚</p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ‰äº›æ¥å£æ˜¯æ ‡å‡†åŒ–çš„ï¼Œé›·æ‰“ä¸åŠ¨ï¼Œå°±åƒé’¢ç­‹ã€ç –ç“¦ã€èºä¸ã€é’‰å­ã€æ’åº§ç­‰è¿™äº›ææ–™ä¸€æ ·ï¼Œæ— è®ºè¦æ„ç­‘çš„æˆ¿å­æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œè¿™äº›æ ‡å‡†ç»„ä»¶çš„æ¥å£åœ¨ç¡®å®šä¸‹æ¥åï¼Œéƒ½ä¸ä¼šæ”¹å˜ï¼Œå®ƒä»¬å°±åƒ Rust è¯­è¨€æ ‡å‡†åº“ä¸­çš„æ ‡å‡† trait ä¸€æ ·ã€‚</p><p>è€Œæœ‰äº›æ¥å£æ˜¯è·Ÿæ„é€ çš„æˆ¿å­æ¯æ¯ç›¸å…³çš„ï¼Œæ¯”å¦‚é—¨çª—ã€ç”µå™¨ã€å®¶å…·ç­‰ï¼Œå®ƒä»¬å°±åƒä½ è¦è®¾è®¡çš„ç³»ç»Ÿä¸­çš„ trait ä¸€æ ·ï¼Œå¯ä»¥æŠŠç³»ç»Ÿçš„å„ä¸ªéƒ¨åˆ†è”ç»“èµ·æ¥ï¼Œæœ€ç»ˆå‘ˆç°ç»™ç”¨æˆ·ä¸€ä¸ªå®Œæ•´çš„ä½¿ç”¨ä½“éªŒã€‚</p><p>ä¹‹å‰è®²äº†trait çš„åŸºç¡€çŸ¥è¯†ï¼Œä¹Ÿä»‹ç»äº†å¦‚ä½•åœ¨å®æˆ˜ä¸­ä½¿ç”¨ trait å’Œ trait objectã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å†èŠ±ä¸€è®²çš„æ—¶é—´ï¼Œæ¥çœ‹çœ‹å¦‚ä½•å›´ç»•ç€ trait æ¥è®¾è®¡å’Œæ¶æ„ç³»ç»Ÿã€‚</p><p>ç”±äºåœ¨è®²æ¶æ„å’Œè®¾è®¡æ—¶ï¼Œä¸å…è¦å¼•å…¥éœ€æ±‚ï¼Œç„¶åæˆ‘éœ€è¦è§£é‡Šè¿™éœ€æ±‚çš„æ¥é¾™å»è„‰ï¼Œå†æä¾›è®¾è®¡æ€è·¯ï¼Œå†ä»‹ç» trait åœ¨å…¶ä¸­çš„ä½œç”¨ï¼Œä½†è¿™æ ·ä¸‹æ¥ï¼Œä¸€å ‚è¯¾çš„å†…å®¹èƒ½è®²å¥½ä¸€ä¸ªç³»ç»Ÿè®¾è®¡å°±ä¸é”™äº†ã€‚æ‰€ä»¥æˆ‘ä»¬æ¢ä¸ªæ–¹å¼ï¼ŒæŠŠä¹‹å‰è®¾è®¡è¿‡çš„ç³»ç»Ÿæ‹ä¸€ä¸‹ï¼Œé‡æ¸©å®ƒä»¬çš„ trait è®¾è®¡ï¼Œçœ‹çœ‹å…¶ä¸­çš„æ€è·¯ä»¥åŠå–èˆã€‚</p><!-- [[[read_end]]] --><h2>ç”¨ trait è®©ä»£ç è‡ªç„¶èˆ’æœå¥½ç”¨</h2><p>åœ¨<a href="https://time.geekbang.org/column/article/413634">ç¬¬ 5 è®²</a>ï¼Œthumbor çš„é¡¹ç›®é‡Œï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ª SpecTransform traitï¼Œé€šè¿‡å®ƒå¯ä»¥ç»Ÿä¸€å¤„ç†ä»»æ„ç±»å‹çš„ã€æè¿°æˆ‘ä»¬å¸Œæœ›å¦‚ä½•å¤„ç†å›¾ç‰‡çš„ specï¼š</p><pre><code class="language-protobuf">// ä¸€ä¸ª spec å¯ä»¥åŒ…å«ä¸Šè¿°çš„å¤„ç†æ–¹å¼ä¹‹ä¸€ï¼ˆè¿™æ˜¯ protobuf å®šä¹‰ï¼‰
message Spec {
  oneof data {
    Resize resize = 1;
    Crop crop = 2;
    Flipv flipv = 3;
    Fliph fliph = 4;
    Contrast contrast = 5;
    Filter filter = 6;
    Watermark watermark = 7;
  }
}
</code></pre><p>SpecTransform trait çš„å®šä¹‰å¦‚ä¸‹ï¼ˆ<a href="https://github.com/tyrchen/geektime-rust/blob/master/05_thumbor/src/engine/mod.rs#L16">ä»£ç </a>ï¼‰ï¼š</p><pre><code class="language-rust">// SpecTransformï¼šæœªæ¥å¦‚æœæ·»åŠ æ›´å¤šçš„ specï¼Œåªéœ€è¦å®ç°å®ƒå³å¯
pub trait SpecTransform&lt;T&gt; {
    // å¯¹å›¾ç‰‡ä½¿ç”¨ op åš transform
    fn transform(&amp;mut self, op: T);
}
</code></pre><p>å®ƒå¯ä»¥ç”¨æ¥å¯¹å›¾ç‰‡ä½¿ç”¨æŸä¸ª spec è¿›è¡Œå¤„ç†ã€‚</p><p>ä½†å¦‚æœä½ é˜…è¯» GitHub ä¸Šçš„æºç ï¼Œä½ å¯èƒ½ä¼šå‘ç°ä¸€ä¸ªæ²¡ç”¨åˆ°çš„æ–‡ä»¶ <a href="http://imageproc.rs">imageproc.rs</a> ä¸­ç±»ä¼¼çš„ traitï¼ˆ<a href="https://github.com/tyrchen/geektime-rust/blob/master/05_thumbor/src/imageproc.rs#L41">ä»£ç </a>ï¼‰ï¼š</p><pre><code class="language-rust">pub trait ImageTransform {
    fn transform(&amp;self, image: &amp;mut PhotonImage);
}
</code></pre><p>è¿™ä¸ª trait æ˜¯ç¬¬ä¸€ç‰ˆçš„ traitã€‚æˆ‘ä¾æ—§ä¿ç•™ç€å®ƒï¼Œå°±æ˜¯æƒ³åœ¨æ­¤å±•ç¤ºä¸€ä¸‹ trait è®¾è®¡ä¸Šçš„å–èˆã€‚</p><p>å½“ä½ å®¡è§†è¿™æ®µä»£ç çš„æ—¶å€™ä¼šä¸ä¼šè§‰å¾—ï¼Œè¿™ä¸ª trait çš„è®¾è®¡æœ‰äº›è‰ç‡ï¼Ÿå› ä¸ºå¦‚æœä¼ å…¥çš„ image æ¥è‡ªä¸åŒçš„å›¾ç‰‡å¤„ç†å¼•æ“ï¼Œè€ŒæŸä¸ªå›¾ç‰‡å¼•æ“æä¾›çš„ image ç±»å‹ä¸æ˜¯ PhotonImageï¼Œé‚£è¿™ä¸ªæ¥å£ä¸å°±æ— æ³•ä½¿ç”¨äº†ä¹ˆï¼Ÿ</p><p>hmmï¼Œè¿™æ˜¯ä¸ªè®¾è®¡ä¸Šçš„å¤§é—®é¢˜å•Šã€‚æƒ³æƒ³çœ‹ï¼Œä»¥ç›®å‰æ‰€å­¦çš„çŸ¥è¯†ï¼Œæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä»€ä¹ˆå¯ä»¥å¸®åŠ©æˆ‘ä»¬å»¶è¿Ÿ image æ˜¯å¦å¿…é¡»æ˜¯ PhotonImage çš„å†³ç­–å‘¢ï¼Ÿ</p><p>å¯¹ï¼Œæ³›å‹ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³›å‹ trait ä¿®æ”¹ä¸€ä¸‹åˆšæ‰é‚£æ®µä»£ç ï¼š</p><pre><code class="language-rust">// ä½¿ç”¨ trait å¯ä»¥ç»Ÿä¸€å¤„ç†çš„æ¥å£ï¼Œä»¥åæ— è®ºå¢åŠ å¤šå°‘åŠŸèƒ½ï¼Œåªéœ€è¦åŠ æ–°çš„ Specï¼Œç„¶åå®ç° ImageTransform æ¥å£
pub trait ImageTransform&lt;Image&gt; {
    fn transform(&amp;self, image: &amp;mut Image);
}
</code></pre><p>æŠŠä¼ å…¥çš„ image ç±»å‹æŠ½è±¡æˆæ³›å‹ç±»å‹ä¹‹åï¼Œå»¶è¿Ÿäº†å›¾ç‰‡ç±»å‹åˆ¤æ–­å’Œæ”¯æŒçš„å†³ç­–ï¼Œå¯ç”¨æ€§æ›´é«˜ã€‚</p><p>ä½†å¦‚æœä½ ç»§ç»­å¯¹æ¯”ç°åœ¨çš„ ImageTransformå’Œä¹‹å‰å†™çš„ SpecTransformï¼Œä¼šå‘ç°ï¼Œå®ƒä»¬å®ç° trait çš„æ•°æ®ç»“æ„å’Œç”¨åœ¨ trait ä¸Šçš„æ³›å‹å‚æ•°ï¼Œæ­£å¥½æ‰äº†ä¸ªä¸ªã€‚</p><p>ä½ çœ‹ï¼ŒPhotonImage ä¸‹å¯¹äº Contrast çš„ ImageTransform çš„å®ç°ï¼š</p><pre><code class="language-rust">impl ImageTransform&lt;PhotonImage&gt; for Contrast {
    fn transform(&amp;self, image: &amp;mut Image) {
        effects::adjust_contrast(image, self.contrast);
    }
}
</code></pre><p>è€ŒåŒæ ·çš„ï¼ŒPhotonImage ä¸‹å¯¹ Contract çš„ SpecTransform çš„å®ç°ï¼š</p><pre><code class="language-rust">impl SpecTransform&lt;&amp;Contrast&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Contrast) {
        effects::adjust_contrast(&amp;mut self.0, op.contrast);
    }
}
</code></pre><p>è¿™ä¸¤ç§æ–¹å¼åŸºæœ¬ä¸Šç­‰ä»·ï¼Œä½†ä¸€ä¸ªå›´ç»•ç€ Spec å±•å¼€ï¼Œä¸€ä¸ªå›´ç»•ç€ Image å±•å¼€ï¼š<br>
<img src="https://static001.geekbang.org/resource/image/05/93/05052aff8a2204ddba4fd4aee81ce193.jpg?wh=2364x1740" alt=""></p><p>é‚£ä¹ˆï¼Œå“ªç§è®¾è®¡æ›´å¥½å‘¢ï¼Ÿ</p><p>å…¶å®äºŒè€…å¹¶æ²¡æœ‰åŠŸèƒ½ä¸Šæˆ–è€…æ€§èƒ½ä¸Šçš„ä¼˜åŠ£ã€‚</p><p>é‚£ä¸ºä»€ä¹ˆæˆ‘é€‰æ‹©äº† SpecTransform çš„è®¾è®¡å‘¢ï¼Ÿåœ¨ç¬¬ä¸€ç‰ˆçš„è®¾è®¡æˆ‘è¿˜æ²¡æœ‰è€ƒè™‘ Engineçš„æ—¶å€™ï¼Œæ˜¯ä»¥ Spec ä¸ºä¸­å¿ƒçš„ï¼›ä½†åœ¨æŠŠ Engine è€ƒè™‘è¿›å»åï¼Œæˆ‘ä»¥ Engine ä¸ºä¸­å¿ƒé‡æ–°åšäº†è®¾è®¡ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå¼€å‘æ–°çš„ Engine çš„æ—¶å€™ï¼ŒSpecTransform trait ç”¨èµ·æ¥æ›´é¡ºæ‰‹ï¼Œæ›´è‡ªç„¶ä¸€äº›ã€‚</p><p>å—¯ï¼Œé¡ºæ‰‹ï¼Œè‡ªç„¶ã€‚æ¥å£çš„è®¾è®¡ä¸€å®šè¦å…³æ³¨ä½¿ç”¨è€…çš„ä½“éªŒï¼Œä¸€ä¸ªä½¿ç”¨èµ·æ¥æ„Ÿè§‰è‡ªç„¶é¡ºæ‰‹èˆ’æœçš„æ¥å£ï¼Œå°±æ˜¯æ›´å¥½çš„æ¥å£ã€‚<strong>å› ä¸ºè¿™æ„å‘³ç€ä½¿ç”¨çš„æ—¶å€™ï¼Œä»£ç å¯ä»¥è‡ªç„¶è€Œç„¶å†™å‡ºæ¥ï¼Œè€Œæ— éœ€çœ‹æ–‡æ¡£</strong>ã€‚</p><p>æ¯”å¦‚åŒæ ·æ˜¯ Python ä»£ç ï¼š</p><pre><code class="language-python">df[df["age"] &gt; 10]
</code></pre><p>å°±è¦æ¯”ï¼š</p><pre><code class="language-python">df.filter(df.col("age").gt(10))
</code></pre><p>è¦æ›´åŠ è‡ªç„¶èˆ’æœã€‚å‰é¢çš„ä»£ç ï¼Œä½ çœ‹ä¸€çœ¼åˆ«äººæ€ä¹ˆç”¨ï¼Œè‡ªå·±å°±å¾ˆå¿«èƒ½å†™å‡ºæ¥ï¼Œè€Œåè€…ï¼Œä½ éœ€è¦å…ˆææ¸…æ¥š filter å‡½æ•°æ˜¯æ€ä¹ˆå›äº‹ï¼Œä»¥åŠcol()ã€gt() è¿™ä¸¤ä¸ªæ–¹æ³•å¦‚ä½•ä½¿ç”¨ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹æ¥ä¸¤æ®µ Rust ä»£ç ã€‚è¿™è¡Œä½¿ç”¨äº† From/Into trait çš„ä»£ç ï¼š</p><pre><code class="language-rust">let url = generate_url_with_spec(image_spec.into());
</code></pre><p>å°±è¦æ¯”ï¼š</p><pre><code class="language-rust">let data = image_spec.encode_to_vec();
let s = encode_config(data, URL_SAFE_NO_PAD);
let url = generate_url_with_spec(s);
</code></pre><p>è¦ç®€æ´ã€è‡ªç„¶å¾—å¤šã€‚å®ƒæŠŠå®ç°ç»†èŠ‚éƒ½å±è”½äº†èµ·æ¥ï¼Œåªè®©ç”¨æˆ·å…³å¿ƒä»–ä»¬éœ€è¦å…³å¿ƒçš„é€»è¾‘ã€‚<br>
æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨è®¾è®¡ trait çš„æ—¶å€™ï¼Œé™¤äº†å…³æ³¨åŠŸèƒ½ï¼Œè¿˜è¦æ³¨æ„æ˜¯å¦å¥½ç”¨ã€æ˜“ç”¨ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä»‹ç» KV server çš„æ—¶å€™ï¼Œä¸æ–­å¼ºè°ƒï¼Œtrait åœ¨è®¾è®¡ç»“æŸä¹‹åï¼Œä¸è¦å…ˆç€æ€¥æ’°å†™å®ç° trait çš„ä»£ç ï¼Œè€Œæ˜¯æœ€å¥½å…ˆå†™ä¸€äº›å¯¹äº trait ä½¿ç”¨çš„æµ‹è¯•ä»£ç ã€‚</p><p>ä½ åœ¨å†™è¿™äº›æµ‹è¯•ä»£ç çš„ä½¿ç”¨ä½“éªŒï¼Œå°±æ˜¯åˆ«äººåœ¨ä½¿ç”¨ä½ çš„ trait æ„å»ºç³»ç»Ÿæ—¶çš„çœŸå®ä½“éªŒï¼Œå¦‚æœå®ƒç”¨èµ·æ¥åˆ«æ‰­ã€å•°å—¦ï¼Œä¸çœ‹æ–‡æ¡£å°±ä¸å®¹æ˜“ç”¨å¯¹ï¼Œé‚£è¿™ä¸ª trait æœ¬èº«è¿˜æœ‰å¾…è¿›ä¸€æ­¥è¿­ä»£ã€‚</p><h2>ç”¨ trait åšæ¡¥æ¥</h2><p>åœ¨è½¯ä»¶å¼€å‘çš„ç»å¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä¸ä¼šä»é›¶åˆ°ä¸€å®Œå®Œå…¨å…¨è®¾è®¡å’Œæ„å»ºç³»ç»Ÿçš„æ‰€æœ‰éƒ¨åˆ†ã€‚å°±åƒç›–æˆ¿å­ï¼Œä¸å¯èƒ½ä»ä¸€æŠ”åœŸã€ä¸€å—ç“¦ç‰‡å¼€å§‹æ‰“é€ ã€‚æˆ‘ä»¬éœ€è¦ä¾èµ–ç”Ÿæ€ç³»ç»Ÿä¸­å·²æœ‰çš„ç»„ä»¶ã€‚</p><p>ä½œä¸ºæ¶æ„å¸ˆï¼Œä½ çš„èŒè´£æ˜¯åœ¨ç”Ÿæ€ç³»ç»Ÿä¸­æ‰¾åˆ°åˆé€‚çš„ç»„ä»¶ï¼Œè¿åŒä½ è‡ªå·±æ‰“é€ çš„éƒ¨åˆ†ï¼Œä¸€èµ·ç²˜åˆèµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªäº§å“ã€‚æ‰€ä»¥ï¼Œä½ ä¼šé‡åˆ°é‚£äº›æ¥å£ä¸ä½ é¢„æœŸä¸ç¬¦çš„ç»„ä»¶ï¼Œå¯æ˜¯è‡ªå·±åˆæ— æ³•æ”¹å˜é‚£äº›ç»„ä»¶æ¥è®©æ¥å£æ»¡è¶³ä½ çš„é¢„æœŸï¼Œæ€ä¹ˆåŠï¼Ÿ</p><p>æ­¤åˆ»ï¼Œæˆ‘ä»¬éœ€è¦æ¡¥æ¥ã€‚</p><p>å°±åƒè¦ç”¨çš„ç”µå™¨æ˜¯äºŒç›¸æ’å£ï¼Œè€Œé™„è¿‘å¢™ä¸Šçš„æ’åº§åªæœ‰ä¸‰ç›¸æ’å£ï¼Œæˆ‘ä»¬æ€»ä¸èƒ½ä¿®æ”¹ç”µå™¨æˆ–è€…å¢™ä¸Šçš„æ’åº§ï¼Œä½¿å…¶æ»¡è¶³å¯¹æ–¹å§ï¼Ÿæ­£ç¡®çš„åšæ³•æ˜¯è´­ç½®ä¸€ä¸ªå¤šé¡¹æ’åº§æ¥æ¡¥æ¥äºŒè€…ã€‚</p><p>åœ¨ Rust é‡Œï¼Œæ¡¥æ¥çš„å·¥ä½œå¯ä»¥é€šè¿‡å‡½æ•°æ¥å®Œæˆï¼Œä½†æœ€å¥½é€šè¿‡ trait æ¥æ¡¥æ¥ã€‚ç»§ç»­çœ‹<a href="https://time.geekbang.org/column/article/413634">ç¬¬ 5 è®² </a>thumbor é‡Œçš„å¦ä¸€ä¸ª trait Engineï¼ˆ<a href="https://github.com/tyrchen/geektime-rust/blob/master/05_thumbor/src/engine/mod.rs#L8">ä»£ç </a>ï¼‰ï¼š</p><pre><code class="language-rust">// Engine traitï¼šæœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šçš„ engineï¼Œä¸»æµç¨‹åªéœ€è¦æ›¿æ¢ engine
pub trait Engine {
    // å¯¹ engine æŒ‰ç…§ specs è¿›è¡Œä¸€ç³»åˆ—æœ‰åºçš„å¤„ç†
    fn apply(&amp;mut self, specs: &amp;[Spec]);
    // ä» engine ä¸­ç”Ÿæˆç›®æ ‡å›¾ç‰‡ï¼Œæ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ selfï¼Œè€Œé self çš„å¼•ç”¨
    fn generate(self, format: ImageOutputFormat) -&gt; Vec&lt;u8&gt;;
}
</code></pre><p>é€šè¿‡ Engine è¿™ä¸ª traitï¼Œæˆ‘ä»¬æŠŠç¬¬ä¸‰æ–¹çš„åº“ photonå’Œè‡ªå·±è®¾è®¡çš„ Image Spec è¿æ¥èµ·æ¥ï¼Œä½¿å¾—æˆ‘ä»¬ä¸ç”¨å…³å¿ƒ Engine èƒŒåç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œåªéœ€è¦è°ƒç”¨ apply å’Œ generate æ–¹æ³•å³å¯ï¼š</p><pre><code class="language-rust">// ä½¿ç”¨ image engine å¤„ç†
let mut engine: Photon = data
    .try_into()
    .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;
engine.apply(&amp;spec.specs);
let image = engine.generate(ImageOutputFormat::Jpeg(85));
</code></pre><p>è¿™æ®µä»£ç ä¸­ï¼Œç”±äºä¹‹å‰ä¸º Photon å®ç°äº† TryFrom&lt;Bytes&gt;ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è°ƒç”¨ try_into() æ¥å¾—åˆ°ä¸€ä¸ª photon engineï¼š</p><pre><code class="language-rust">// ä» Bytes è½¬æ¢æˆ Photon ç»“æ„
impl TryFrom&lt;Bytes&gt; for Photon {
    type Error = anyhow::Error;

    fn try_from(data: Bytes) -&gt; Result&lt;Self, Self::Error&gt; {
        Ok(Self(open_image_from_bytes(&amp;data)?))
    }
}
</code></pre><p>å°±æ¡¥æ¥ thumbor ä»£ç å’Œ photon crate è€Œè¨€ï¼ŒEngine è¡¨ç°è‰¯å¥½ï¼Œå®ƒè®©æˆ‘ä»¬ä¸ä½†å¾ˆå®¹æ˜“ä½¿ç”¨ photon crateï¼Œè¿˜å¯ä»¥å¾ˆæ–¹ä¾¿åœ¨æœªæ¥éœ€è¦çš„æ—¶å€™æ›¿æ¢æ‰ photon crateã€‚</p><p>ä¸è¿‡ï¼ŒEngine åœ¨æ„é€ æ—¶ï¼Œæ‰€åšçš„æ¡¥æ¥è¿˜æ˜¯ä¸å¤Ÿç›´è§‚å’Œè‡ªç„¶ï¼Œå¦‚æœä¸ä»”ç»†çœ‹ä»£ç æˆ–è€…æ–‡æ¡£ï¼Œä½¿ç”¨è€…å¯èƒ½å¹¶ä¸æ¸…æ¥šï¼Œç¬¬3è¡Œä»£ç ï¼Œå¦‚ä½•é€šè¿‡ TryFrom/TryInto å¾—åˆ°ä¸€ä¸ªå®ç°äº† Engine çš„ç»“æ„ã€‚ä»è¿™ä¸ªä½¿ç”¨ä½“éªŒæ¥çœ‹ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›é€šè¿‡ä½¿ç”¨ Engine traitï¼Œä»»ä½•ä¸€ä¸ªå›¾ç‰‡å¼•æ“éƒ½å¯ä»¥ç»Ÿä¸€åœ°åˆ›å»º Engineç»“æ„ã€‚æ€ä¹ˆåŠï¼Ÿ</p><p>å¯ä»¥ä¸ºè¿™ä¸ª trait æ·»åŠ ä¸€ä¸ªç¼ºçœçš„ create æ–¹æ³•ï¼š</p><pre><code class="language-rust">// Engine traitï¼šæœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šçš„ engineï¼Œä¸»æµç¨‹åªéœ€è¦æ›¿æ¢ engine
pub trait Engine {
    // ç”Ÿæˆä¸€ä¸ªæ–°çš„ engine
    fn create&lt;T&gt;(data: T) -&gt; Result&lt;Self&gt;
    where
        Self: Sized,
        T: TryInto&lt;Self&gt;,
    {
        data.try_into()
            .map_err(|_| anyhow!("failed to create engine"))
    }
    // å¯¹ engine æŒ‰ç…§ specs è¿›è¡Œä¸€ç³»åˆ—æœ‰åºçš„å¤„ç†
    fn apply(&amp;mut self, specs: &amp;[Spec]);
    // ä» engine ä¸­ç”Ÿæˆç›®æ ‡å›¾ç‰‡ï¼Œæ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ selfï¼Œè€Œé self çš„å¼•ç”¨
    fn generate(self, format: ImageOutputFormat) -&gt; Vec&lt;u8&gt;;
}
</code></pre><p>æ³¨æ„çœ‹æ–° create æ–¹æ³•çš„çº¦æŸï¼šä»»ä½• Tï¼Œåªè¦å®ç°äº†ç›¸åº”çš„ TryFrom/TryIntoï¼Œå°±å¯ä»¥ç”¨è¿™ä¸ªç¼ºçœçš„ create() æ–¹æ³•æ¥æ„é€  Engineã€‚</p><p>æœ‰äº†è¿™ä¸ªæ¥å£åï¼Œä¸Šé¢ä½¿ç”¨ engine çš„ä»£ç å¯ä»¥æ›´åŠ ç›´è§‚ï¼Œçœæ‰äº†ç¬¬3è¡Œçš„try_into()å¤„ç†ï¼š</p><pre><code class="language-rust">// ä½¿ç”¨ image engine å¤„ç†
let mut engine = Photon::create(data)
    .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;
engine.apply(&amp;spec.specs);
let image = engine.generate(ImageOutputFormat::Jpeg(85));
</code></pre><p>æ¡¥æ¥æ˜¯æ¶æ„ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„æ€æƒ³ï¼Œæˆ‘ä»¬ä¸€å®šè¦æŒæ¡è¿™ä¸ªæ€æƒ³çš„ç²¾é«“ã€‚</p><p>å†ä¸¾ä¸ªä¾‹å­ã€‚æ¯”å¦‚ç°åœ¨æƒ³è¦ç³»ç»Ÿå¯ä»¥é€šè¿‡è®¿é—®æŸä¸ª REST APIï¼Œå¾—åˆ°ç”¨æˆ·è‡ªå·±å‘å¸ƒçš„ã€æŒ‰æ—¶é—´é¡ºåºå€’æ’çš„æœ‹å‹åœˆã€‚æ€ä¹ˆå†™è¿™æ®µä»£ç å‘¢ï¼Ÿæœ€ç®€å•ç²—æš´çš„æ–¹å¼æ˜¯ï¼š</p><pre><code class="language-rust">let secret_api = api_with_user_token(&amp;user, params);
let data: Vec&lt;Status&gt; = reqwest::get(secret_api)?.json()?;
</code></pre><p>æ›´å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨ trait æ¡¥æ¥æ¥å±è”½å®ç°ç»†èŠ‚ï¼š</p><pre><code class="language-rust">pub trait FriendCircle {
	  fn get_published(&amp;self, user: &amp;User) -&gt; Result&lt;Vec&lt;Status&gt;, FriendCircleError&gt;;
    ... 
}
</code></pre><p>è¿™æ ·ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ä»£ç å¯ä»¥å›´ç»•ç€è¿™ä¸ªæ¥å£å±•å¼€ï¼Œè€Œæ— éœ€å…³å¿ƒå®ƒå…·ä½“çš„å®ç°æ˜¯æ¥è‡ª REST APIï¼Œè¿˜æ˜¯å…¶å®ƒä»€ä¹ˆåœ°æ–¹ï¼›ä¹Ÿä¸ç”¨å…³å¿ƒå®ç°åšæ²¡åš cacheã€æœ‰æ²¡æœ‰é‡ä¼ æœºåˆ¶ã€å…·ä½“éƒ½ä¼šè¿”å›ä»€ä¹ˆæ ·çš„é”™è¯¯ï¼ˆFriendCircleError å°±å·²ç»æä¾›äº†æ‰€æœ‰çš„å‡ºé”™å¯èƒ½ï¼‰ç­‰ç­‰ã€‚</p><h2>ä½¿ç”¨ trait æä¾›æ§åˆ¶åè½¬</h2><p>ç»§ç»­çœ‹åˆšæ‰çš„Engine ä»£ç ï¼Œåœ¨ Engine å’Œ T ä¹‹é—´é€šè¿‡ TryInto trait è¿›è¡Œäº†è§£è€¦ï¼Œä½¿å¾—è°ƒç”¨è€…å¯ä»¥çµæ´»å¤„ç†ä»–ä»¬çš„ Tï¼š</p><pre><code class="language-rust">pub trait Engine {
    // ç”Ÿæˆä¸€ä¸ªæ–°çš„ engine
    fn create&lt;T&gt;(data: T) -&gt; Result&lt;Self&gt;
    where
        Self: Sized,
        T: TryInto&lt;Self&gt;,
    {
        data.try_into()
            .map_err(|_| anyhow!("failed to create engine"))
    }
    ...
}
</code></pre><p>è¿™é‡Œè¿˜ä½“ç°äº†trait åœ¨è®¾è®¡ä¸­ï¼Œå¦ä¸€ä¸ªå¾ˆé‡è¦çš„ä½œç”¨ï¼Œæ§åˆ¶åè½¬ã€‚</p><p>é€šè¿‡ä½¿ç”¨ traitï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è®¾è®¡åº•å±‚åº“çš„æ—¶å€™å‘Šè¯‰ä¸Šå±‚ï¼š<strong>æˆ‘éœ€è¦æŸä¸ªæ»¡è¶³ trait X çš„æ•°æ®ï¼Œå› ä¸ºæˆ‘ä¾èµ–è¿™ä¸ªæ•°æ®å®ç°çš„ trait X æ–¹æ³•æ¥å®ŒæˆæŸäº›åŠŸèƒ½ï¼Œä½†è¿™ä¸ªæ•°æ®å…·ä½“æ€ä¹ˆå®ç°ï¼Œæˆ‘ä¸çŸ¥é“ï¼Œä¹Ÿä¸å…³å¿ƒ</strong>ã€‚</p><p>åˆšæ‰ä¸º Engine æ–°æ„å»ºçš„ create æ–¹æ³•ã€‚T æ˜¯å®ç° Engine æ‰€éœ€è¦çš„ä¾èµ–ï¼Œæˆ‘ä»¬ä¸çŸ¥é“å±äºç±»å‹ T çš„ data æ˜¯å¦‚ä½•åœ¨ä¸Šä¸‹æ–‡ä¸­äº§ç”Ÿçš„ï¼Œä¹Ÿä¸å…³å¿ƒ T å…·ä½“æ˜¯ä»€ä¹ˆï¼Œåªè¦ T å®ç°äº† TryInto&lt;Self&gt; å³å¯ã€‚è¿™å°±æ˜¯å…¸å‹çš„æ§åˆ¶åè½¬ã€‚</p><p>ä½¿ç”¨ trait åšæ§åˆ¶åè½¬å¦ä¸€ä¸ªä¾‹å­æ˜¯<a href="https://time.geekbang.org/column/article/414478">ç¬¬ 6 è®²</a>ä¸­çš„ <a href="https://docs.rs/sqlparser/0.12.0/sqlparser/dialect/trait.Dialect.html">Dialect trait</a>ï¼ˆ<a href="https://docs.rs/sqlparser/0.12.0/src/sqlparser/dialect/mod.rs.html#43-56">ä»£ç </a>ï¼‰ï¼š</p><pre><code class="language-rust">pub trait Dialect: Debug + Any {
    /// Determine if a character starts a quoted identifier. The default
    /// implementation, accepting "double quoted" ids is both ANSI-compliant
    /// and appropriate for most dialects (with the notable exception of
    /// MySQL, MS SQL, and sqlite). You can accept one of characters listed
    /// in `Word::matching_end_quote` here
    fn is_delimited_identifier_start(&amp;self, ch: char) -&gt; bool {
        ch == '"'
    }
    /// Determine if a character is a valid start character for an unquoted identifier
    fn is_identifier_start(&amp;self, ch: char) -&gt; bool;
    /// Determine if a character is a valid unquoted identifier character
    fn is_identifier_part(&amp;self, ch: char) -&gt; bool;
}
</code></pre><p>æˆ‘ä»¬åªéœ€è¦ä¸ºè‡ªå·±çš„ SQL æ–¹è¨€å®ç° Dialect traitï¼š</p><pre><code class="language-rust">// åˆ›å»ºè‡ªå·±çš„ sql æ–¹è¨€ã€‚TyrDialect æ”¯æŒ identifier å¯ä»¥æ˜¯ç®€å•çš„ url
impl Dialect for TyrDialect {
    fn is_identifier_start(&amp;self, ch: char) -&gt; bool {
        ('a'..='z').contains(&amp;ch) || ('A'..='Z').contains(&amp;ch) || ch == '_'
    }

    // identifier å¯ä»¥æœ‰ ':', '/', '?', '&amp;', '='
    fn is_identifier_part(&amp;self, ch: char) -&gt; bool {
        ('a'..='z').contains(&amp;ch)
            || ('A'..='Z').contains(&amp;ch)
            || ('0'..='9').contains(&amp;ch)
            || [':', '/', '?', '&amp;', '=', '-', '_', '.'].contains(&amp;ch)
    }
}
</code></pre><p>å°±å¯ä»¥è®© sql parser è§£ææˆ‘ä»¬çš„ SQL æ–¹è¨€ï¼š</p><pre><code class="language-rust">let ast = Parser::parse_sql(&amp;TyrDialect::default(), sql.as_ref())?;
</code></pre><p>è¿™å°±æ˜¯ Dialect è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„ trait çš„å¼ºå¤§ç”¨é€”ã€‚</p><p>å¯¹äºæˆ‘ä»¬è¿™äº›ä½¿ç”¨è€…æ¥è¯´ï¼Œé€šè¿‡Dialect traitï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ³¨å…¥è‡ªå·±çš„è§£æå‡½æ•°ï¼Œæ¥æä¾›æˆ‘ä»¬çš„ SQL æ–¹è¨€çš„é¢å¤–ä¿¡æ¯ï¼›å¯¹äº sqlparser è¿™ä¸ªåº“çš„ä½œè€…æ¥è¯´ï¼Œé€šè¿‡ Dialect traitï¼Œä»–ä¸å¿…å…³å¿ƒæœªæ¥ä¼šæœ‰å¤šå°‘æ–¹è¨€ã€æ¯ä¸ªæ–¹è¨€é•¿ä»€ä¹ˆæ ·å­ï¼Œåªéœ€è¦æ–¹è¨€çš„ä½œè€…å‘Šè¯‰ä»–å¦‚ä½• tokenize ä¸€ä¸ªæ ‡è¯†ç¬¦å³å¯ã€‚</p><p>æ§åˆ¶åè½¬æ˜¯æ¶æ„ä¸­ç»å¸¸ä½¿ç”¨åˆ°çš„åŠŸèƒ½ï¼Œå®ƒèƒ½å¤Ÿ<strong>è®©è°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…ä¹‹é—´çš„å…³ç³»åœ¨æŸä¸ªæ—¶åˆ»è°ƒè½¬è¿‡æ¥ï¼Œè¢«è°ƒç”¨è€…åè¿‡æ¥è°ƒç”¨è°ƒç”¨è€…æä¾›çš„èƒ½åŠ›ï¼ŒäºŒè€…ååŒå®Œæˆä¸€äº›äº‹æƒ…</strong>ã€‚</p><p>æ¯”å¦‚ MapReduce çš„æ¶æ„ï¼šç”¨äº map çš„æ–¹æ³•å’Œç”¨äº reduce çš„æ–¹æ³•æ˜¯å•¥ï¼ŒMapReduce çš„æ¶æ„è®¾è®¡è€…å¹¶ä¸æ¸…æ¥šï¼Œä½†è°ƒç”¨è€…å¯ä»¥æŠŠè¿™äº›æ–¹æ³•æä¾›ç»™ MapReduce æ¶æ„ï¼Œç”± MapReduce æ¶æ„åœ¨åˆé€‚çš„æ—¶å€™è¿›è¡Œè°ƒç”¨ã€‚</p><p>å½“ç„¶ï¼Œæ§åˆ¶åè½¬å¹¶éåªèƒ½ç”± trait æ¥å®Œæˆï¼Œä½†ä½¿ç”¨ trait åšæ§åˆ¶åè½¬ä¼šéå¸¸çµæ´»ï¼Œè°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…åªéœ€è¦å…³å¿ƒå®ƒä»¬ä¹‹é—´çš„æ¥å£ï¼Œè€Œéå…·ä½“çš„æ•°æ®ç»“æ„ã€‚</p><h2>ç”¨ trait å®ç° SOLID åŸåˆ™</h2><p>å…¶å®åˆšæ‰ä»‹ç»çš„ç”¨ trait åšæ§åˆ¶åè½¬ï¼Œæ ¸å¿ƒä½“ç°çš„å°±æ˜¯é¢å‘å¯¹è±¡è®¾è®¡æ—¶SOLIDåŸåˆ™ä¸­çš„ï¼Œä¾èµ–åè½¬åŸåˆ™DIPï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ„å»ºçµæ´»ç³»ç»Ÿçš„æ€æƒ³ã€‚</p><p>åœ¨åšé¢å‘å¯¹è±¡è®¾è®¡æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šæ¢è®¨ <a href="https://en.wikipedia.org/wiki/SOLID">SOLID åŸåˆ™</a>ï¼š</p><ul>
<li>SRPï¼šå•ä¸€èŒè´£åŸåˆ™ï¼Œæ˜¯æŒ‡æ¯ä¸ªæ¨¡å—åº”è¯¥åªè´Ÿè´£å•ä¸€çš„åŠŸèƒ½ï¼Œä¸åº”è¯¥è®©å¤šä¸ªåŠŸèƒ½è€¦åˆåœ¨ä¸€èµ·ï¼Œè€Œæ˜¯åº”è¯¥å°†å…¶ç»„åˆåœ¨ä¸€èµ·ã€‚</li>
<li>OCPï¼šå¼€é—­åŸåˆ™ï¼Œæ˜¯æŒ‡è½¯ä»¶ç³»ç»Ÿåº”è¯¥å¯¹ä¿®æ”¹å…³é—­ï¼Œè€Œå¯¹æ‰©å±•å¼€æ”¾ã€‚</li>
<li>LSPï¼šé‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œæ˜¯æŒ‡å¦‚æœç»„ä»¶å¯æ›¿æ¢ï¼Œé‚£ä¹ˆè¿™äº›å¯æ›¿æ¢çš„ç»„ä»¶åº”è¯¥éµå®ˆç›¸åŒçš„çº¦æŸï¼Œæˆ–è€…è¯´æ¥å£ã€‚</li>
<li>ISPï¼šæ¥å£éš”ç¦»åŸåˆ™ï¼Œæ˜¯æŒ‡ä½¿ç”¨è€…åªéœ€è¦çŸ¥é“ä»–ä»¬æ„Ÿå…´è¶£çš„æ–¹æ³•ï¼Œè€Œä¸è¯¥è¢«è¿«äº†è§£å’Œä½¿ç”¨å¯¹ä»–ä»¬æ¥è¯´æ— ç”¨çš„æ–¹æ³•æˆ–è€…åŠŸèƒ½ã€‚</li>
<li>DIPï¼šä¾èµ–åè½¬åŸåˆ™ï¼Œæ˜¯æŒ‡æŸäº›åœºåˆä¸‹åº•å±‚ä»£ç åº”è¯¥ä¾èµ–é«˜å±‚ä»£ç ï¼Œè€Œéé«˜å±‚ä»£ç å»ä¾èµ–åº•å±‚ä»£ç ã€‚</li>
</ul><p>è™½ç„¶ Rust ä¸æ˜¯ä¸€é—¨é¢å‘å¯¹è±¡è¯­è¨€ï¼Œä½†è¿™äº›æ€æƒ³éƒ½æ˜¯é€šç”¨çš„ã€‚</p><p>åœ¨è¿‡å»çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä¸€ç›´å¼ºè°ƒ SRP å’Œ OCPã€‚ä½ çœ‹<a href="https://time.geekbang.org/column/article/414478">ç¬¬ 6 è®²</a>çš„ Fetch / Load traitï¼Œå®ƒä»¬éƒ½åªè´Ÿè´£ä¸€ä¸ªå¾ˆç®€å•çš„åŠ¨ä½œï¼š</p><pre><code class="language-rust">#[async_trait]
pub trait Fetch {
    type Error;
    async fn fetch(&amp;self) -&gt; Result&lt;String, Self::Error&gt;;
}

pub trait Load {
    type Error;
    fn load(self) -&gt; Result&lt;DataSet, Self::Error&gt;;
}
</code></pre><p>ä»¥ Fetch ä¸ºä¾‹ï¼Œæˆ‘ä»¬å…ˆå®ç°äº† UrlFetcherï¼Œåæ¥åˆæ ¹æ®éœ€è¦ï¼Œå®ç°äº† FileFetcherã€‚</p><p>FileFetcher çš„å®ç°å¹¶ä¸ä¼šå¯¹ UrlFetcher çš„å®ç°ä»£ç æœ‰ä»»ä½•å½±å“ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å®ç° FileFetcher çš„æ—¶å€™ï¼Œå·²æœ‰çš„æ‰€æœ‰å®ç°äº† Fetch æ¥å£çš„ä»£ç éƒ½æ˜¯ç¨³å®šçš„ï¼Œå®ƒä»¬å¯¹ä¿®æ”¹æ˜¯å…³é—­çš„ï¼›åŒæ—¶ï¼Œåœ¨å®ç° FileFetcher çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰©å±•äº†ç³»ç»Ÿçš„èƒ½åŠ›ï¼Œä½¿ç³»ç»Ÿå¯ä»¥æ ¹æ®ä¸åŒçš„å‰ç¼€ï¼ˆ<code>from file://</code> æˆ–è€… <code>from &lt;http://</code>&gt;ï¼‰è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œè¿™æ˜¯å¯¹æ‰©å±•å¼€æ”¾ã€‚</p><p>å‰é¢æåˆ°çš„ SpecTransform / Engine traitï¼ŒåŒ…æ‹¬<a href="https://time.geekbang.org/column/article/425001"> 21 è®²</a>ä¸­ KV server é‡Œæ¶‰åŠçš„ CommandService traitï¼š</p><pre><code class="language-rust">/// å¯¹ Command çš„å¤„ç†çš„æŠ½è±¡
pub trait CommandService {
    /// å¤„ç† Commandï¼Œè¿”å› Response
    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse;
}
</code></pre><p>ä¹Ÿæ˜¯ SRP å’Œ OCP åŸåˆ™çš„è·µè¡Œè€…ã€‚</p><p>LSP é‡Œæ°æ›¿æ¢åŸåˆ™è‡ªä¸å¿…è¯´ï¼Œæˆ‘ä»¬æœ¬æ–‡ä¸­æ‰€æœ‰çš„å†…å®¹éƒ½åœ¨è·µè¡Œé€šè¿‡ä½¿ç”¨æ¥å£ï¼Œæ¥ä½¿ç»„ä»¶å¯æ›¿æ¢ã€‚æ¯”å¦‚ä¸Šæ–‡æåˆ°çš„ Engine traitï¼Œåœ¨ KV server ä¸­æˆ‘ä»¬ä½¿ç”¨çš„ Storage traitï¼Œéƒ½å…è®¸æˆ‘ä»¬åœ¨ä¸æ”¹å˜ä»£ç æ ¸å¿ƒé€»è¾‘çš„å‰æä¸‹ï¼Œæ›¿æ¢å…¶ä¸­çš„ä¸»è¦ç»„ä»¶ã€‚</p><p>è‡³äº ISP æ¥å£éš”ç¦»åŸåˆ™ï¼Œæˆ‘ä»¬ç›®å‰æ’°å†™çš„ trait éƒ½å¾ˆç®€å•ï¼Œå¤©ç„¶æ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™ã€‚å…¶å®ï¼Œå¤§éƒ¨åˆ†æ—¶å€™ï¼Œå½“ä½ çš„ trait æ»¡è¶³ SRP å•ä¸€èŒè´£åŸåˆ™æ—¶ï¼Œå®ƒä¹Ÿæ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™ã€‚</p><p>ä½†åœ¨ Rust ä¸­ï¼Œæœ‰äº› trait çš„æ¥å£å¯èƒ½ä¼šæ¯”è¾ƒåºæ‚ï¼Œ<strong>æ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å‡è½»è°ƒç”¨è€…çš„è´Ÿæ‹…ï¼Œè®©å®ƒä»¬èƒ½å¤Ÿåœ¨éœ€è¦çš„æ—¶å€™æ‰å¼•å…¥æŸäº›æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨ trait çš„ç»§æ‰¿</strong>ã€‚æ¯”å¦‚ AsyncRead / AsyncWrite / Stream å’Œå®ƒä»¬å¯¹åº”çš„ AsyncReadExt / AsyncWriteExt / StreamExt ç­‰ã€‚è¿™æ ·ï¼Œå¤æ‚çš„æ¥å£è¢«ä¸åŒçš„ trait åˆ†æ‹…äº†å¹¶éš”ç¦»å¼€ã€‚</p><h2>å°ç»“</h2><p>æ¥å£è®¾è®¡æ˜¯æ¶æ„è®¾è®¡ä¸­æœ€æ ¸å¿ƒçš„ç¯èŠ‚ã€‚<strong>å¥½çš„æ¥å£å®¹æ˜“ä½¿ç”¨ï¼Œå¾ˆéš¾è¯¯ç”¨ï¼Œä¼šè®©ä½¿ç”¨æ¥å£çš„äººäº§ç”Ÿå…±é¸£</strong>ã€‚å½“æˆ‘ä»¬è¯´ä¸€æ®µä»£ç è¯»èµ·æ¥/å†™èµ·æ¥æ„Ÿè§‰å¾ˆèˆ’æœï¼Œæˆ–è€…å¾ˆä¸èˆ’æœã€å¾ˆå†—é•¿ã€å¾ˆéš¾çœ‹ï¼Œè¿™ç§æ„Ÿè§‰å¾€å¾€å°±æ¥è‡ªäºæ¥å£ç»™äººçš„æ„Ÿè§‰ï¼Œæˆ‘ä»¬å¯ä»¥å¦¥å–„ä½¿ç”¨ trait æ¥é™ä½ç”šè‡³æ¶ˆé™¤è¿™ç§ä¸èˆ’æœçš„æ„Ÿè§‰ã€‚</p><p>å½“æˆ‘ä»¬çš„ä»£ç å’Œå…¶ä»–äººçš„ä»£ç å…±å­˜æ—¶ï¼Œæ¥å£åœ¨ä¸åŒçš„ç»„ä»¶ä¹‹é—´å°±èµ·åˆ°äº†æ¡¥æ¥çš„ä½œç”¨ã€‚é€šè¿‡æ¡¥æ¥ï¼Œç”šè‡³å¯ä»¥æŠŠåŸæœ¬è®¾è®¡ä¸å¥½çš„ä»£ç ï¼Œå…ˆç”¨æ¥å£å°è£…æˆæˆ‘ä»¬å¸Œæœ›çš„æ ·å­ï¼Œç„¶åå®ç°è¿™ä¸ªç®€å•çš„åŒ…è£…ï¼Œä¹‹åå†æ…¢æ…¢æ”¹åŠ¨åŸå…ˆä¸å¥½çš„è®¾è®¡ã€‚</p><p>è¿™æ ·ï¼Œç”±äºç³»ç»Ÿçš„å…¶å®ƒéƒ¨åˆ†ä½¿ç”¨æ–°çš„æ¥å£å¤„ç†ï¼Œæœªæ¥æ”¹åŠ¨çš„å½±å“è¢«æ§åˆ¶åœ¨å¾ˆå°çš„èŒƒå›´ã€‚åœ¨ç¬¬ 5 è®²è®¾è®¡ thumbor çš„æ—¶å€™æˆ‘ä¹Ÿæåˆ°ï¼Œphoton åº“å¹¶ä¸æ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„åº“ï¼Œç„¶è€Œï¼Œé€šè¿‡ Engine trait çš„æ¡¥æ¥ï¼Œæœªæ¥å³ä½¿æˆ‘ä»¬ fork ä¸€ä¸‹ photon åº“ï¼Œå¯¹å…¶å¤§æ”¹ï¼Œå¹¶ä¸ä¼šå½±å“ thumbor çš„ä»£ç ã€‚</p><p>æœ€åï¼Œåœ¨è½¯ä»¶è®¾è®¡æ—¶ï¼Œæˆ‘ä»¬è¿˜è¦æ³¨æ„ SOLID åŸåˆ™ã€‚åŸºæœ¬ä¸Šï¼Œ<strong>å¥½çš„ traitï¼Œè®¾è®¡ä¸€å®šæ˜¯ç¬¦åˆ SOLID åŸåˆ™çš„</strong>ï¼Œä» Rust æ ‡å‡†åº“çš„è®¾è®¡ï¼Œä»¥åŠä¹‹å‰è®²åˆ°çš„ traitï¼Œç»“åˆä»Šå¤©çš„è§£è¯»ï¼Œæƒ³å¿…ä½ å¯¹æ­¤æœ‰äº†ä¸€å®šçš„è®¤è¯†ã€‚æœªæ¥åœ¨ä½¿ç”¨ trait æ„å»ºä½ è‡ªå·±çš„æ¥å£æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥å°† SOLID åŸåˆ™ä½œä¸ºä¸€ä¸ªå¤‡å¿˜æ¸…å•ï¼Œéšæ—¶æ£€æŸ¥ã€‚</p><h3>æ€è€ƒé¢˜</h3><p>Rust ä¸‹æœ‰ä¸€ä¸ªå¤„ç† Web å‰ç«¯çš„åº“å« <a href="https://github.com/yewstack/yew">yew</a>ã€‚è¯· clone åˆ°ä½ æœ¬åœ°ï¼Œç„¶åä½¿ç”¨ ag æˆ–è€… rgrepï¼ˆeat our own dogfoodï¼‰æŸ¥æ‰¾ä¸€ä¸‹æ‰€æœ‰çš„ trait å®šä¹‰ï¼Œçœ‹çœ‹è¿™äº› trait è¢«è®¾è®¡çš„ç›®çš„å’Œæ„ä¹‰ï¼Œå¹¶ä¸”ç€é‡é˜…è¯»ä¸€ä¸‹å®ƒæœ€æ ¸å¿ƒçš„ Component traitï¼Œæ€è€ƒå‡ ä¸ªé—®é¢˜ï¼š</p><ol>
<li>Component trait å¯ä»¥åš trait object ä¹ˆï¼Ÿ</li>
<li>å…³è”ç±»å‹ Message å’Œ Properties çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li>ä½œä¸ºä½¿ç”¨è€…ï¼Œè¯¥å¦‚ä½•ç”¨ Component traitï¼Ÿå®ƒçš„ lifecycle æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ</li>
<li>å¦‚æœä½ ä¹‹å‰æœ‰å‰ç«¯å¼€å‘çš„ç»éªŒï¼Œæ¯”è¾ƒä¸€ä¸‹ React / Vue / Elm component å’Œ yew component çš„åŒºåˆ«ï¼Ÿ</li>
</ol><pre><code class="language-rust">yew on î‚  master via ğŸ¦€ v1.55.0
â¯ rgrep "pub trait" "**/*.rs"
examples/router/src/generator.rs
   155:1   pub trait Generated: Sized {
packages/yew/src/html/component/mod.rs
    42:1   pub trait Component: Sized + 'static {
packages/yew/src/html/component/properties.rs
     6:1   pub trait Properties: PartialEq {
examples/boids/src/math.rs
   128:1   pub trait WeightedMean&lt;T = Self&gt;: Sized {
   152:1   pub trait Mean&lt;T = Self&gt;: Sized {
packages/yew/src/functional/mod.rs
    69:1   pub trait FunctionProvider {
packages/yew/src/html/conversion.rs
     5:1   pub trait ImplicitClone: Clone {}
    18:1   pub trait IntoPropValue&lt;T&gt; {
packages/yew/src/html/listener/mod.rs
    27:1   pub trait TargetCast
   136:1   pub trait IntoEventCallback&lt;EVENT&gt; {
packages/yew/src/scheduler.rs
    11:1   pub trait Runnable {
packages/yew-router/src/routable.rs
    16:1   pub trait Routable: Sized + Clone {
packages/yew-agent/src/pool.rs
    60:1   pub trait Dispatched: Agent + Sized + 'static {
    78:1   pub trait Dispatchable {}
packages/yew/src/html/component/scope.rs
   508:1   pub trait SendAsMessage&lt;COMP: Component&gt; {
packages/yew-macro/src/stringify.rs
    16:1   pub trait Stringify {
packages/yew-agent/src/lib.rs
    22:1   pub trait Agent: Sized + 'static {
    82:1   pub trait Discoverer {
    92:1   pub trait Bridge&lt;AGN: Agent&gt; {
    98:1   pub trait Bridged: Agent + Sized + 'static {
packages/yew-agent/src/utils/store.rs
    20:1   pub trait Store: Sized + 'static {
   138:1   pub trait Bridgeable: Sized + 'static {
packages/yew-macro/src/html_tree/mod.rs
   178:1   pub trait ToNodeIterator {
packages/yew/src/virtual_dom/listeners.rs
    42:1   pub trait Listener {
packages/yew-agent/src/worker/mod.rs
    17:1   pub trait Threaded {
    24:1   pub trait Packed {
</code></pre><p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚ä»Šå¤©ä½ å·²ç»å®ŒæˆRustå­¦ä¹ çš„ç¬¬25æ¬¡æ‰“å¡å•¦ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼</p>
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é«˜æ¥¼ã€‚</p><p>åœ¨ç¬¬ 6 è®²ï¼Œæˆ‘ä»¬è¯´è¿‡ç›®å‰ä¸»æµçš„æµé‡å›æ”¾å·¥å…·éƒ½æ— æ³•è½»æ˜“è§£å†³ session çš„é—®é¢˜ï¼Œæ‰€ä»¥ä»ç³»ç»Ÿå®‰å…¨çš„è§’åº¦æ¥è¯´ï¼Œå·¥å…·éœ€è¦åšå¯¹åº”çš„æ”¹é€ ã€‚</p><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬æ¥èŠä¸€ä¸‹ GoReplay å¦‚ä½•é€šè¿‡æ”¹é€ è§£å†³å›æ”¾è¿‡ç¨‹ä¸­åŠ¨æ€æ•°æ®å…³è”çš„é—®é¢˜ã€‚</p><h2>å…³è”æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>æˆ‘ä»¬å¯ä»¥æŠŠå…³è”ç®€å•åœ°ç†è§£ä¸ºæŠŠæœåŠ¡ç«¯è¿”å›çš„æŸä¸ªå€¼ï¼Œä¼ é€’ç»™åç»­çš„è°ƒç”¨ä½¿ç”¨ã€‚æˆ‘ä»¬å¯ä»¥åœ¨å¾ˆå¤šåœºæ™¯ç”¨åˆ°å®ƒã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¸¸è§çš„â€œSession IDâ€å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„éœ€è¦å…³è”çš„æ•°æ®ã€‚å®ƒéœ€è¦åœ¨äº¤äº’è¿‡ç¨‹ä¸­æ ‡è¯†ä¸€ä¸ªå®¢æˆ·ç«¯èº«ä»½ï¼Œè¿™ä¸ªèº«ä»½è¦åœ¨åç»­çš„è°ƒç”¨ä¸­ä¸€ç›´å­˜åœ¨ï¼Œå¦åˆ™æœåŠ¡ç«¯å°±ä¸è®¤è¯†è¿™ä¸ªå®¢æˆ·ç«¯äº†ã€‚</p><p>å¯¹æ¯ä¸€ä¸ªæ€§èƒ½æµ‹è¯•å·¥å…·æ¥è¯´ï¼Œå…³è”æ˜¯åº”è¯¥å…·å¤‡çš„åŸºæœ¬åŠŸèƒ½ï¼ŒGoReplay ä¹Ÿä¸ä¾‹å¤–ã€‚</p><p>ä½†æ˜¯æœ‰å¾ˆå¤šæ–°æ‰‹åŒå­¦å¯¹å…³è”çš„é€»è¾‘å¹¶ä¸æ˜¯ååˆ†ç†è§£ï¼Œç”šè‡³æœ‰äººè§‰å¾—å…³è”å’Œå‚æ•°åŒ–ï¼ˆæµé‡æ•°æ®ï¼‰æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬ç”¨çš„éƒ½æ˜¯åŠ¨æ€çš„æ•°æ®ï¼Œå¹¶ä¸”å…³è”è¿‡æ¥çš„æ•°æ®ä¹Ÿå¯ä»¥ç”¨åˆ°å‚æ•°åŒ–ï¼ˆæµé‡æ•°æ®ï¼‰ä¸­ã€‚å…¶å®ï¼Œè¿™äºŒè€…è¿˜æ˜¯æœ‰æ‰€ä¸åŒçš„ï¼Œå› ä¸ºå…³è”çš„æ•°æ®åç»­è„šæœ¬ä¸­ä¼šç”¨åˆ°ï¼Œä½†å‚æ•°åŒ–å°±ä¸ä¼šã€‚</p><p>ç°åœ¨æœ‰å¾ˆå¤šå…¨é“¾è·¯å‹æµ‹éƒ½æ˜¯ç”±å•æ¥å£åŸºå‡†åˆ›å»ºçš„ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå…³è”å°±ç”¨å¾—æ¯”è¾ƒå°‘ã€‚å› ä¸ºæ¥å£çº§çš„åŸºå‡†åœºæ™¯éƒ½æ˜¯ä¸€å‘ä¸€æ”¶å°±ç»“æŸäº†ï¼Œä¸éœ€è¦å°†æ•°æ®ä¿å­˜ä¸‹æ¥å†å‘é€å‡ºå»ã€‚</p><p>é‚£ä¹ˆæ­£å¸¸æƒ…å†µä¸‹ï¼Œä»€ä¹ˆæ ·çš„åœºæ™¯éœ€è¦å…³è”å‘¢ï¼Ÿä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ å®ƒä»¬éœ€è¦æ»¡è¶³ä¸‹é¢å‡ ä¸ªæ¡ä»¶ï¼š</p><!-- [[[read_end]]] --><ol>
<li>æ•°æ®æ˜¯ç”±æœåŠ¡å™¨ç«¯ç”Ÿæˆçš„ï¼›</li>
<li>æ•°æ®åœ¨æ¯ä¸€æ¬¡è¯·æ±‚æ—¶éƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼›</li>
<li>æ•°æ®åœ¨åç»­çš„è¯·æ±‚ä¸­éœ€è¦å†å‘é€å‡ºå»ã€‚</li>
</ol><p>ä½ å¯ä»¥é€šè¿‡è¿™å¼ ç¤ºæ„å›¾åŠ æ·±ä¸€ä¸‹ç†è§£ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/6f/62/6f28747510866b140821bfd83ea9bb62.jpg?wh=1264x802" alt="å›¾ç‰‡"></p><p>å¥½äº†ï¼Œæˆ‘ä»¬çŸ¥é“äº†å…³è”çš„åŸºæœ¬æ¦‚å¿µå’Œé€‚ç”¨åœºæ™¯ï¼Œé‚£ä¹ˆåœ¨ GoReplay ä¸­åˆå¦‚ä½•æ”¹é€ å‘¢ï¼Ÿ</p><p>ä½œä¸ºä¸€æ¬¾æµé‡å›æ”¾å·¥å…·ï¼Œæˆ‘ä»¬çŸ¥é“GoReplayçš„æ ¸å¿ƒåŸç†å°±æ˜¯åŸºäºæµé‡æ–‡ä»¶å»å€æ•°å›æ”¾è¯·æ±‚ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªæµé‡æ–‡ä»¶æ˜¯ä¸ªæ­»çš„ä¸œè¥¿ï¼Œæ˜¯ä¸èƒ½åŠ¨æ€å‚æ•°æ•°æ®çš„ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬åˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦æ¬å‡º GoReplay çš„ä¸­é—´ä»¶äº†ã€‚</p><h2>ä¸­é—´ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><a href="https://github.com/buger/goreplay/wiki/middleware">ä¸­é—´ä»¶</a>ï¼ˆ <a href="https://github.com/buger/goreplay/wiki/middleware">Middleware</a> ï¼‰æ˜¯ä¸€ä¸ªåœ¨ STDINï¼ˆæ ‡å‡†è¾“å…¥ï¼‰ æ¥æ”¶è¯·æ±‚ã€å“åº” payload ï¼ˆæœ‰æ•ˆè¯·æ±‚è´Ÿè½½ï¼‰å¹¶åœ¨ STDOUTï¼ˆæ ‡å‡†è¾“å‡ºï¼‰ å‘å‡ºä¿®æ”¹è¯·æ±‚çš„ç¨‹åºã€‚ä½ å¯ä»¥åœ¨ä¸­é—´ä»¶ä¸Šå®ç°ä»»ä½•è‡ªå®šä¹‰é€»è¾‘ï¼Œæ¯”å¦‚è®¤è¯ã€å¤æ‚çš„é‡å†™å’Œç­›é€‰è¯·æ±‚ç­‰ã€‚</p><p>é€šè¿‡ä¼ å…¥ Middleware å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å‘é€å‘½ä»¤ç»™ GoReplayï¼ŒGoReplay ä¼šæ‹‰èµ·ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ã€‚åœ¨å½•åˆ¶è¿‡ç¨‹ä¸­ï¼ŒGoReplay é€šè¿‡è·å–è¿›ç¨‹çš„ STDIN å’Œ STDOUT ä¸è¾“å…¥è¾“å‡ºæ’ä»¶è¿›ç¨‹è¿›è¡Œé€šä¿¡ï¼Œä¸­é—´ä»¶å†…éƒ¨é€»è¾‘ä¸º STDERRï¼Œæ•°æ®æµå‘å¤§è‡´å¦‚ä¸‹ï¼š</p><pre><code class="language-bash">                   Original request      +--------------+
+-------------+----------STDIN----------&gt;+              |
|  Gor input  |                          |  Middleware  |
+-------------+----------STDIN----------&gt;+              |
                   Original response     +------+---+---+
                                                |   ^
+-------------+    Modified request             v   |
| Gor output  +&lt;---------STDOUT-----------------+   |
+-----+-------+                                     |
      |                                             |
      |            Replayed response                |
      +------------------STDIN-----------------&gt;----+
</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå¸Œæœ›è®°å½•åŸå§‹å“åº”å’Œå›æ”¾å“åº”ï¼Œä¸è¦å¿˜è®°æ·»åŠ  <strong>â€“ output-http-track-response</strong> å’Œ <strong>â€“ input-raw-track-response</strong> å‚æ•°ã€‚</p><p>GoReplay æ”¯æŒç”¨ä»»ä½•è¯­è¨€ç¼–å†™ä¸­é—´ä»¶çš„åè®®ï¼ŒåŒæ—¶ä¸­é—´ä»¶ç¨‹åºè¿˜éœ€è¦æ ¼å¤–æ³¨æ„ä¸€ç‚¹ï¼Œå°±æ˜¯ä¸­é—´ä»¶å’Œ Gor çš„æ‰€æœ‰é€šä¿¡éƒ½æ˜¯å¼‚æ­¥ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿è¯åŸå§‹è¯·æ±‚å’Œå“åº”æ¶ˆæ¯ä¼šä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å‡ºç°ã€‚å¦‚æœä¸šåŠ¡é€»è¾‘ä¾èµ–äºåŸå§‹å“åº”æˆ–å›æ”¾å“åº”ï¼Œé‚£ä¹ˆä¸­é—´ä»¶åº”ç”¨ç¨‹åºå°±åº”è¯¥å¤„ç†å¥½çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¦åšå¥½åŠ¨æ€æ•°æ®çš„å¤„ç†åŠ¨ä½œã€‚</p><p>ä¸ºäº†ç®€åŒ–ä¸­é—´ä»¶çš„åŠŸèƒ½å®ç°ï¼Œå®˜æ–¹ä¸º <a href="https://github.com/buger/goreplay/tree/master/middleware">node.js </a>å’Œ Go (å³å°†æ¨å‡º)æä¾›äº†åŒ…ã€‚</p><h2>å¦‚ä½•ä½¿ç”¨ä¸­é—´ä»¶ï¼Ÿ</h2><p>é‚£ä¹ˆï¼Œåº”è¯¥æ€æ ·ä½¿ç”¨ä¸­é—´ä»¶å‘¢ï¼Ÿ</p><p>ä¸‹é¢å°±æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ bash echo ä¸­é—´ä»¶çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬ç”¨å®ƒæ¥æ‰“å°å¯¹åº”çš„ payload ç±»å‹ï¼š</p><pre><code>#!/usr/bin/env bash
#
# `xxd` utility included into vim-common package
# It allow hex decoding/encoding
# 
# This example may broke if you request contains `null` string, you may consider using pipes instead.
# See: https://github.com/buger/gor/issues/309
# 

function log {
    # Logging to stderr, because stdout/stdin used for data transfer
    # è®°å½•åˆ° stderrï¼Œå›  ä¸º stdout/stdin ç”¨äºæ•°æ®ä¼ è¾“
    &gt;&amp;2 echo &quot;[DEBUG][ECHO] $1&quot;
}

while read line; do
    decoded=$(echo -e &quot;$line&quot; | xxd -r -p)

    header=$(echo -e &quot;$decoded&quot; | head -n +1)
    payload=$(echo -e &quot;$decoded&quot; | tail -n +2)

    encoded=$(echo -e &quot;$header\n$payload&quot; | xxd -p | tr -d &quot;\\n&quot;)

    log &quot;&quot;
    log &quot;===================================&quot;

    case ${header:0:1} in
    &quot;1&quot;)
        log &quot;Request type: Request&quot;
        ;;
    &quot;2&quot;)
        log &quot;Request type: Original Response&quot;
        ;;
    &quot;3&quot;)
        log &quot;Request type: Replayed Response&quot;
        ;;
    *)
        log &quot;Unknown request type $header&quot;
    esac
    echo &quot;$encoded&quot;

    log &quot;===================================&quot;

    log &quot;Original data: $line&quot;
    log &quot;Decoded request: $decoded&quot;
    log &quot;Encoded data: $encoded&quot;
done;
</code></pre><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ã€ä¼šå‘˜ç™»å½•æ¥å£ã€‘æ¥åšæ¼”ç¤ºã€‚</p><p><img src="https://static001.geekbang.org/resource/image/yy/18/yy0d0a5afb7e1a295c0e10b94b989518.png?wh=1282x941" alt="å›¾ç‰‡"></p><p>é¦–å…ˆï¼Œé€šè¿‡æŒ‡å®š Middleware å¯æ‰§è¡Œæ–‡ä»¶çš„å‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ Middleware å‚æ•°åœ¨ GoReplay å¯ç”¨ä¸­é—´ä»¶åŠŸèƒ½ï¼š</p><pre><code class="language-bash"> sudo ./goreplay --input-raw :8081 --middleware "./echo.sh" --output-http "http://staging.server"
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ Postman å¯¹ã€ä¼šå‘˜ç™»å½•ã€‘æ¥å£åšä¸€æ¬¡æµ‹è¯•ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/0c/c4/0cd47ef4bfd1b47513bc36d312db33c4.png?wh=633x479" alt="å›¾ç‰‡"></p><p>é€šè¿‡æ§åˆ¶å°æˆ‘ä»¬çœ‹åˆ°ï¼Œä¸­é—´ä»¶ç¨‹åºå·²ç»æˆåŠŸæŠŠç»è¿‡çš„æµé‡ä¿¡æ¯å…¨éƒ¨æ‰“å°å‡ºæ¥äº†ã€‚</p><pre><code class="language-bash">Interface: en0 . BPF Filter: ((tcp dst port 8081) and (dst host fe80::8f6:ee40:ebd1:bec or dst host 192.168.3.58))
Interface: awdl0 . BPF Filter: ((tcp dst port 8081) and (dst host fe80::50a5:ceff:feeb:47e3))
Interface: llw0 . BPF Filter: ((tcp dst port 8081) and (dst host fe80::50a5:ceff:feeb:47e3))
Interface: utun0 . BPF Filter: ((tcp dst port 8081) and (dst host fe80::d9a3:ab1b:f8e4:4de))
Interface: utun1 . BPF Filter: ((tcp dst port 8081) and (dst host fe80::c2a0:19a0:9d9d:6699))
Interface: utun2 . BPF Filter: ((tcp dst port 8081) and (dst host fe80::771:4985:8642:7857))
Interface: utun3 . BPF Filter: ((tcp dst port 8081) and (dst host fe80::4a93:e598:6e37:37b3))
Interface: lo0 . BPF Filter: ((tcp dst port 8081) and (dst host 127.0.0.1 or dst host ::1 or dst host fe80::1))
2021/11/14 17:16:34 [PPID 8021 and PID 8022] Version:1.3.0
[DEBUG][ECHO] 
[DEBUG][ECHO] ===================================
[DEBUG][ECHO] Request type: Request
[DEBUG][ECHO] ===================================
[DEBUG][ECHO] Original data: 3120636239663166393130303030303030313535353939393337203136333638383133393937363036333730303020300a504f5354202f61646d696e2f6c6f67696e20485454502f312e310d0a436f6e74656e742d547970653a206170706c69636174696f6e2f6a736f6e0d0a417574686f72697a6174696f6e3a20747275650d0a557365722d4167656e743a20506f73746d616e52756e74696d652f372e32382e340d0a4163636570743a202a2f2a0d0a506f73746d616e2d546f6b656e3a2034666132356536622d666434362d346539362d386166362d6636633562613066303033660d0a486f73743a206c6f63616c686f73743a383038310d0a4163636570742d456e636f64696e673a20677a69702c206465666c6174652c2062720d0a436f6e6e656374696f6e3a206b6565702d616c6976650d0a436f6e74656e742d4c656e6774683a2035320d0a0d0a7b0a202020202270617373776f7264223a2022313233343536222c0a2020202022757365726e616d65223a202274657374220a7d
[DEBUG][ECHO] Decoded request: 1 cb9f1f910000000155599937 1636881399760637000 0
POST /admin/login HTTP/1.1
Content-Type: application/json
Authorization: true
User-Agent: PostmanRuntime/7.28.4
Accept: */*
Postman-Token: 4fa25e6b-fd46-4e96-8af6-f6c5ba0f003f
Host: localhost:8081
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Content-Length: 52

{
    "password": "123456",
    "username": "test"
}
[DEBUG][ECHO] Encoded data: 3120636239663166393130303030303030313535353939393337203136333638383133393937363036333730303020300a504f5354202f61646d696e2f6c6f67696e20485454502f312e310d0a436f6e74656e742d547970653a206170706c69636174696f6e2f6a736f6e0d0a417574686f72697a6174696f6e3a20747275650d0a557365722d4167656e743a20506f73746d616e52756e74696d652f372e32382e340d0a4163636570743a202a2f2a0d0a506f73746d616e2d546f6b656e3a2034666132356536622d666434362d346539362d386166362d6636633562613066303033660d0a486f73743a206c6f63616c686f73743a383038310d0a4163636570742d456e636f64696e673a20677a69702c206465666c6174652c2062720d0a436f6e6e656374696f6e3a206b6565702d616c6976650d0a436f6e74656e742d4c656e6774683a2035320d0a0d0a7b0a202020202270617373776f7264223a2022313233343536222c0a2020202022757365726e616d65223a202274657374220a7d0a
</code></pre><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†ä¸­é—´ä»¶çš„åŸºæœ¬åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å›åˆ°è¿™èŠ‚è¯¾çš„ä¸»é¢˜ï¼Œå¦‚ä½•å®ç°å…³è”æ“ä½œï¼Ÿ</p><h2>å¦‚ä½•å®ç°å›æ”¾å…³è”ï¼Ÿ</h2><p>è¿™é‡Œæˆ‘ä»¬å¼•å…¥â€œä¼šå‘˜ç™»å½•â€å’Œâ€œæŸ¥è¯¢æ‰€æœ‰åå°èµ„æºåˆ†ç±»â€ä¸¤ä¸ªæ¥å£ä¸ºä¾‹ã€‚</p><p>ä½ å¯ä»¥å…ˆçœ‹çœ‹è¿™å¼ æ•´ä½“çš„è¯·æ±‚äº¤äº’ç¤ºæ„å›¾ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/8d/ce/8da2fa743c61455yyd80f63ebe1e18ce.jpg?wh=1424x1953" alt="å›¾ç‰‡"></p><ul>
<li>ä¼šå‘˜ç™»å½•</li>
</ul><p><img src="https://static001.geekbang.org/resource/image/yy/18/yy0d0a5afb7e1a295c0e10b94b989518.png?wh=1282x941" alt="å›¾ç‰‡"></p><ul>
<li>æŸ¥è¯¢æ‰€æœ‰åå°èµ„æºåˆ†ç±»</li>
</ul><p><img src="https://static001.geekbang.org/resource/image/1a/d8/1a1dbcd1f3eb0566308bfed7fa03efd8.png?wh=1296x754" alt="å›¾ç‰‡"></p><p>æˆ‘ä»¬çŸ¥é“ token æ˜¯æœ‰æ—¶æ•ˆçš„ï¼Œå¦‚æœå¤±æ•ˆï¼Œé‚£ä¹ˆäºŒæ¬¡è¯·æ±‚æœåŠ¡ç«¯æ ¡éªŒå°±ä¼šå¤±è´¥ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/b2/96/b20756aca3d9886966984da4096ee596.png?wh=1244x795" alt="å›¾ç‰‡"></p><p>ä¸‹é¢æˆ‘ä»¬å…·ä½“æ¥æ¼”ç¤ºä¸‹å¦‚ä½•è§£å†³tokenå…³è”çš„é—®é¢˜ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œåˆ›å»ºä¸€ä¸ªæµé‡å½•åˆ¶çš„å‘½ä»¤ï¼š</p><pre><code class="language-shell">#!/bin/bash

PORT="8081"
OUT_FILE="request.gor"

sudo ./goreplay --input-raw :$PORT --output-file=$OUT_FILE  -output-file-append --input-raw-track-response --prettify-http
</code></pre><p>å½•åˆ¶ä¸‹çš„æµé‡æ–‡ä»¶å¦‚ä¸‹ï¼š</p><pre><code class="language-shell">1 d1ae1f9100000001e404ee86 1635588156669182000 0
POST /admin/login HTTP/1.1
Content-Type: application/json
Authorization: true
User-Agent: PostmanRuntime/7.28.4
Accept: */*
Postman-Token: 480f15ca-53df-44fd-8980-5e9118b2107e
Host: localhost:8081
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Content-Length: 52

{
    "password": "123456",
    "username": "test"
}

ğŸµğŸ™ˆğŸ™‰
2 d1ae1f9100000001e404ee86 1635588156828973000 458000
HTTP/1.1 200 
Content-Length: 254
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Content-Type: application/json
Date: Sat, 30 Oct 2021 10:02:36 GMT
Keep-Alive: timeout=60
Connection: keep-alive

{"code":200,"message":"æ“ä½œæˆåŠŸ","data":{"tokenHead":"","token":"eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ0ZXN0IiwiY3JlYXRlZCI6MTYzNTU4ODE1Njc5NCwiZXhwIjoxNjM1NTg4MjE2fQ.-wsZa0gijz2KfCF-eAYK1Tt-pd_vw2_LShShlIDCQOsHjOZZlGl8yX2MncZlO9St_oPj1JdBaERjfEU6iu12qw"}}



ğŸµğŸ™ˆğŸ™‰
1 d1ae1f9100000001e405029a 1635588192031592000 0
GET /resource/listAll HTTP/1.1
token: eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ0ZXN0IiwiY3JlYXRlZCI6MTYzNTU4ODE1Njc5NCwiZXhwIjoxNjM1NTg4MjE2fQ.-wsZa0gijz2KfCF-eAYK1Tt-pd_vw2_LShShlIDCQOsHjOZZlGl8yX2MncZlO9St_oPj1JdBaERjfEU6iu12qw
User-Agent: PostmanRuntime/7.28.4
Accept: */*
Postman-Token: 4bc2152e-dbd4-4b2a-b880-72ed5ee4303a
Host: localhost:8081
Accept-Encoding: gzip, deflate, br
Connection: keep-alive

ğŸµğŸ™ˆğŸ™‰
2 d1ae1f9100000001e405029a 1635588192064563000 1084000
HTTP/1.1 200 
Content-Length: 3997
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Content-Type: application/json
Date: Sat, 30 Oct 2021 10:03:12 GMT
Keep-Alive: timeout=60
Connection: keep-alive

{"code":200,"message":"æ“ä½œæˆåŠŸ","data":[{"id":1,"createTime":"2020-02-04T09:04:55.000+00:00","name":"å•†å“å“ç‰Œç®¡ç†","url":"/brand/**","description":null,"categoryId":1},{"id":2,"createTime":"2020-02-04T09:05:35.000+00:00","name":"å•†å“å±æ€§åˆ†ç±»ç®¡ç†","url":"/productAttribute/**","description":null,"categoryId":1},{"id":3,"createTime":"2020-02-04T09:06:13.000+00:00","name":"å•†å“å±æ€§ç®¡ç†","url":"/productAttribute/**","description":null,"categoryId":1},{"id":4,"createTime":"2020-02-04T09:07:15.000+00:00","name":"å•†å“åˆ†ç±»ç®¡ç†","url":"/productCategory/**","description":null,"categoryId":1},{"id":5,"createTime":"2020-02-04T09:09:16.000+00:00","name":"å•†å“ç®¡ç†","url":"/product/**","description":null,"categoryId":1},{"id":6,"createTime":"2020-02-04T09:09:53.000+00:00","name":"å•†å“åº“å­˜ç®¡ç†","url":"/sku/**","description":null,"categoryId":1},{"id":8,"createTime":"2020-02-05T06:43:37.000+00:00","name":"è®¢å•ç®¡ç†","url":"/order/**","description":"","categoryId":2},{"id":9,"createTime":"2020-02-05T06:44:22.000+00:00","name":" è®¢å•é€€è´§ç”³è¯·ç®¡ç†","url":"/returnApply/**","description":"","categoryId":2},{"id":10,"createTime":"2020-02-05T06:45:08.000+00:00","name":"é€€è´§åŸå› ç®¡ç†","url":"/returnReason/**","description":"","categoryId":2},{"id":11,"createTime":"2020-02-05T06:45:43.000+00:00","name":"è®¢å•è®¾ç½®ç®¡ç†","url":"/orderSetting/**","description":"","categoryId":2},{"id":12,"createTime":"2020-02-05T06:46:23.000+00:00","name":"æ”¶è´§åœ°å€ç®¡ç†","url":"/companyAddress/**","description":"","categoryId":2},{"id":13,"createTime":"2020-02-07T08:37:22.000+00:00","name":"ä¼˜æƒ åˆ¸ç®¡ç†","url":"/coupon/**","description":"","categoryId":3},{"id":14,"createTime":"2020-02-07T08:37:59.000+00:00","name":"ä¼˜æƒ åˆ¸é¢†å–è®°å½•ç®¡ç†","url":"/couponHistory/**","description":"","categoryId":3},{"id":15,"createTime":"2020-02-07T08:38:28.000+00:00","name":"é™æ—¶è´­æ´»åŠ¨ç®¡ç†","url":"/flash/**","description":"","categoryId":3},{"id":16,"createTime":"2020-02-07T08:38:59.000+00:00","name":"é™æ—¶è´­å•†å“å…³ç³»ç®¡ç†","url":"/flashProductRelation/**","description":"","categoryId":3},{"id":17,"createTime":"2020-02-07T08:39:22.000+00:00","name":"é™æ—¶è´­åœºæ¬¡ç®¡ç†","url":"/flashSession/**","description":"","categoryId":3},{"id":18,"createTime":"2020-02-07T08:40:07.000+00:00","name":"é¦–é¡µè½®æ’­å¹¿å‘Šç®¡ç†","url":"/home/advertise/**","description":"","categoryId":3},{"id":19,"createTime":"2020-02-07T08:40:34.000+00:00","name":"é¦–é¡µå“ç‰Œç®¡ç†","url":"/home/brand/**","description":"","categoryId":3},{"id":20,"createTime":"2020-02-07T08:41:06.000+00:00","name":"é¦–é¡µæ–°å“ç®¡ç†","url":"/home/newProduct/**","description":"","categoryId":3},{"id":21,"createTime":"2020-02-07T08:42:16.000+00:00","name":"é¦–é¡µäººæ°”æ¨èç®¡ç†","url":"/home/recommendProduct/**","description":"","categoryId":3},{"id":22,"createTime":"2020-02-07T08:42:48.000+00:00","name":"é¦–é¡µä¸“é¢˜æ¨èç®¡ç†","url":"/home/recommendSubject/**","description":"","categoryId":3},{"id":23,"createTime":"2020-02-07T08:44:56.000+00:00","name":" å•†å“ä¼˜é€‰ç®¡ç†","url":"/prefrenceArea/**","description":"","categoryId":5},{"id":24,"createTime":"2020-02-07T08:45:39.000+00:00","name":"å•†å“ä¸“é¢˜ç®¡ç†","url":"/subject/**","description":"","categoryId":5},{"id":25,"createTime":"2020-02-07T08:47:34.000+00:00","name":"åå°ç”¨æˆ·ç®¡ç†","url":"/admin/**","description":"","categoryId":4},{"id":26,"createTime":"2020-02-07T08:48:24.000+00:00","name":"åå°ç”¨æˆ·è§’è‰²ç®¡ç†","url":"/role/**","description":"","categoryId":4},{"id":27,"createTime":"2020-02-07T08:48:48.000+00:00","name":"åå°èœå•ç®¡ç†","url":"/menu/**","description":"","categoryId":4},{"id":28,"createTime":"2020-02-07T08:49:18.000+00:00","name":"åå°èµ„æºåˆ†ç±»ç®¡ç†","url":"/resourceCategory/**","description":"","categoryId":4},{"id":29,"createTime":"2020-02-07T08:49:45.000+00:00","name":"åå°èµ„æºç®¡ç†","url":"/resource/**","description":"","categoryId":4}]}
ğŸµğŸ™ˆğŸ™‰
</code></pre><p>ç¬¬äºŒæ­¥ï¼Œåˆ›å»ºä¸€ä¸ªæµé‡å›æ”¾ Shell è„šæœ¬ã€‚</p><pre><code class="language-shell">#!/bin/bash
## Usage: ./replay.sh

OUTPUT="http://127.0.0.1:8081"
INPUT_FILE="requests.gor"

sudo ./goreplay --input-file $INPUT_FILE --input-file-loop --output-http=$OUTPUT --prettify-http --output-http-track-response --output-stdout
</code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬å°è¯•è¿›è¡Œä¸€æ¬¡å›æ”¾æ“ä½œã€‚</p><p><img src="https://static001.geekbang.org/resource/image/c8/e4/c8e10a5c7b6621cc54d4971b217959e4.png?wh=750x355" alt="å›¾ç‰‡"></p><p>ç­‰å¾…ä¸€ä¼šï¼Œæˆ‘ä»¬çœ‹åˆ°å›æ”¾çš„ã€æŸ¥è¯¢æ‰€æœ‰åå°èµ„æºåˆ†ç±»ã€‘æ¥å£å·²ç»å¤±è´¥äº†ï¼Œæç¤º token å¤±æ•ˆäº†ã€‚</p><p>è¦æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å®æ—¶å°†æ¥è‡ªå½•åˆ¶çš„ token å…³è”åˆ°æ¥è‡ªå›æ”¾å“åº”çš„ token ä¸Š ï¼Œç„¶åä½¿ç”¨å…³è”çš„ token ä¿®æ”¹å›æ”¾çš„è¯·æ±‚ã€‚æˆ‘ä»¬ä½¿ç”¨ GoReplay å­˜å‚¨åº“ä¸­çš„è¿™ä¸ªæ–¹ä¾¿çš„<a href="https://github.com/buger/goreplay/blob/master/examples/middleware/token_modifier.go">ç¤ºä¾‹</a>è¿›è¡Œæ‰©å±•ã€‚</p><p>æ‰€æ¶‰åŠçš„åŸºæœ¬ç®—æ³•ä½ å¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™å¼ å›¾ç‰‡ã€‚<br>
<img src="https://static001.geekbang.org/resource/image/c0/00/c0b9bd3a17b2d34f0ec2d4e1ea5f0e00.jpg?wh=1920x1040" alt=""></p><p>å› ä¸ºåŸå§‹æœåŠ¡å™¨æ²¡æœ‰é¢„å®šä¹‰çš„tokenï¼Œè€Œå›æ”¾æœåŠ¡å™¨æœ‰è‡ªå·±çš„tokenï¼Œå®ƒä¸èƒ½ä¸åŸå§‹æœåŠ¡å™¨åŒæ­¥ã€‚æ‰€ä»¥ä¸ä½¿ç”¨ä¸­é—´ä»¶æˆ–è€…ä¸­é—´ä»¶åªä½¿ç”¨è¯·æ±‚æœ‰æ•ˆ payloadï¼Œéƒ½ä¼šä½¿å¾—tokenå¤±æ•ˆã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çš„ä¸­é—´ä»¶åº”è¯¥è€ƒè™‘å›æ”¾å’ŒæºæœåŠ¡å™¨çš„å“åº”ï¼Œå­˜å‚¨â€™ originalToken -&gt; replayedToken 'åˆ«åï¼Œå¹¶ä½¿ç”¨æ­¤ token é‡å†™æ‰€æœ‰è¯·æ±‚ä»¥ä½¿ç”¨å›æ”¾åˆ«åã€‚</p><p>é¡ºç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬çœ‹ä¸‹ç¬¬å››æ­¥ï¼Œåˆ›å»º token å…³è”ä¸­é—´ä»¶ç¨‹åºã€‚</p><pre><code class="language-go">package main

import (
	"bufio"
	"bytes"
	"encoding/hex"
	"fmt"
	"github.com/bitly/go-simplejson"
	"github.com/buger/goreplay/proto"
	"os"
)

// requestID -&gt; originalToken
// è¯·æ±‚ ID -&gt; åŸå§‹ Token
var originalTokens map[string][]byte

// originalToken -&gt; replayedToken
// åŸå§‹ Token -&gt; å›æ”¾ Token
var tokenAliases map[string][]byte

var json_data interface{}



func main() {
	originalTokens = make(map[string][]byte)
	tokenAliases = make(map[string][]byte)

	scanner := bufio.NewScanner(os.Stdin)

	for scanner.Scan() {
		encoded := scanner.Bytes()
		buf := make([]byte, len(encoded)/2)
		hex.Decode(buf, encoded)

		process(buf)
	}
}

func process(buf []byte) {
	// First byte indicate payload type, possible values:
	//  1 - Request
	//  2 - Response
	//  3 - ReplayedResponse
	// ç¬¬ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºæœ‰æ•ˆè´Ÿè½½ç±»å‹ï¼Œå¯èƒ½çš„å€¼:
	// 1 - è¯·æ±‚
	// 2 - å“åº”
	// 3 - å›æ”¾å“åº”
	payloadType := buf[0]
	headerSize := bytes.IndexByte(buf, '\n') + 1
	header := buf[:headerSize-1]

	// Header contains space separated values of: request type, request id, and request start time (or round-trip time for responses)
	// Header åŒ…å«ç©ºæ ¼åˆ†éš”çš„å€¼:è¯·æ±‚ç±»å‹ï¼Œè¯·æ±‚ idï¼Œè¯·æ±‚å¼€å§‹æ—¶é—´(æˆ–å“åº”çš„å¾€è¿”æ—¶é—´)
	meta := bytes.Split(header, []byte(" "))
	
    // For each request you should receive 3 payloads (request, response, replayed response) with same request id
	// å¯¹äºæ¯ä¸ªè¯·æ±‚ï¼Œä½ åº”è¯¥æ”¶åˆ° 3 ä¸ªæœ‰æ•ˆè´Ÿè½½(request, response, replayed response)ï¼Œå…·æœ‰ç›¸åŒçš„è¯·æ±‚ id
	reqID := string(meta[1])
	payload := buf[headerSize:]

	Debug("Received payload:", string(buf))

	switch payloadType {
	case '1': // Request
		if bytes.Equal(proto.Path(payload), []byte("/admin/login")) {
			originalTokens[reqID] = []byte{}
			Debug("Found token request:", reqID)
		} else {
			//token, vs, _ := proto.PathParam(payload, []byte("token")) //å–åˆ°å›æ”¾å“åº”çš„ token å€¼
			token := proto.Header(payload, []byte("token")) //å–åˆ°åŸå§‹çš„ token å€¼

			Debug("Received token:", string(token))

			if len(token) != 0 { // If there is GET token param
				Debug("If there is GET token param")
				Debug("tokenAliases", tokenAliases)
				if alias, ok := tokenAliases[string(token)]; ok { 		//æ£€æŸ¥è¦æ›¿æ¢çš„ token å€¼æ˜¯å¦å­˜åœ¨
					Debug("Received alias")
					// Rewrite original token to alias
					payload = proto.SetHeader(payload, []byte("token"), alias)  //å°†åŸå§‹çš„ token æ›¿æ¢æˆå›æ”¾çš„ token

					// Copy modified payload to our buffer
					buf = append(buf[:headerSize], payload...)
				}
			}
		}

		// Emitting data back
		os.Stdout.Write(encode(buf)) //é‡å†™è¯·æ±‚å‡†å¤‡å‘å¾€å›æ”¾æœåŠ¡
	case '2': // Original response
		if _, ok := originalTokens[reqID]; ok {
			jsonObject, err := simplejson.NewJson([]byte(proto.Body(payload)))
			if err != nil {
				fmt.Println(err)
			}

			result := jsonObject.Get("data")
			token := result.Get("token")
			secureToken:=token

			f ,_:=secureToken.Bytes()

			originalTokens[reqID] = f
			Debug("Remember origial token:", f)

		}
	case '3': // Replayed response
		if originalToken, ok := originalTokens[reqID]; ok {
			delete(originalTokens, reqID)



			jsonObject, err := simplejson.NewJson([]byte(proto.Body(payload)))
			if err != nil {
				fmt.Println(err)
			}
			result := jsonObject.Get("data")
			token := result.Get("token")
			f ,_:=token.Bytes()
			tokenAliases[string(originalToken)] = f //æ‹¿åˆ°ç°åœ¨çš„ token å€¼ç”¨æ¥æ›¿æ¢æ‰è¿‡å»çš„ token å€¼

			Debug("Create alias for new token token, was:", string(originalToken), "now:", string(f))
		}
	}
}

func encode(buf []byte) []byte {
	dst := make([]byte, len(buf)*2+1)
	hex.Encode(dst, buf)
	dst[len(dst)-1] = '\n'

	return dst
}

func Debug(args ...interface{}) {
	if os.Getenv("GOR_TEST") == "" { // if we are not testing
		fmt.Fprint(os.Stderr, "[DEBUG][TOKEN-MOD] ")
		fmt.Fprintln(os.Stderr, args...)
	}

}
</code></pre><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ process å‡½æ•°å¼‚æ­¥å¤„ç†åŸå§‹è¯·æ±‚æˆ–å›æ”¾å“åº”ä»è€Œé‡æ–°è®¾ç½® tokenã€‚ç”±äº GoReplay çš„æ¯ä¸ªä¸‰å…ƒç»„ï¼ˆè¯·æ±‚ã€å“åº”ã€å›æ”¾å“åº”ï¼‰å…±äº«ä¸€ä¸ªè¯·æ±‚ IDï¼Œå› æ­¤åˆ°è¾¾ä¸­é—´ä»¶çš„ç¬¬ä¸€ä¸ªå“åº”å¯ä»¥å°†å®ƒçš„ token å…³è”åˆ°è¯·æ±‚ IDã€‚å½“ç¬¬äºŒä¸ªå“åº”åˆ°è¾¾æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¿é—®ä¸¤ä¸ª tokenäº†ã€‚æˆ‘ä»¬å¯ä»¥å°†åŸå§‹ token å…³è”åˆ°å›æ”¾çš„ tokenï¼Œå¹¶èƒ½å¤Ÿä¸€ä¸€å¯¹åº”ï¼ˆå› ä¸ºç¬¬äºŒä¸ªå“åº”ç±»å‹ä¹Ÿå¯ç”¨ï¼‰ã€‚</p><p>å¥½äº†ï¼Œè¿™æ ·ä¸­é—´ä»¶å°±å†™å®Œäº†ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æµ‹è¯•ä¸€ä¸‹ã€‚</p><p>æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªè¿è¡Œä¸­é—´ä»¶çš„ Shell è„šæœ¬ middleware_wrapper.shã€‚</p><pre><code class="language-bash">#!/bin/bash
go run token_modifier.go
</code></pre><p>ç¬¬äºŒæ­¥ï¼Œä¿®æ”¹å¯åŠ¨å›æ”¾çš„ Shell è„šæœ¬ replay.shã€‚</p><pre><code class="language-bash">#!/bin/bash
## Usage: ./replay.sh

OUTPUT="http://127.0.0.1:8081"
MIDDLEWARE="./middleware_wrapper.sh"
INPUT_FILE="requests.gor"

sudo ./goreplay --input-file $INPUT_FILE --input-file-loop --output-http=$OUTPUT --middleware $MIDDLEWARE --prettify-http --output-http-track-response --output-stdout
</code></pre><p>æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬å°±è¦ç´§ç›¯è¿è¡Œæ§åˆ¶å°äº†ã€‚</p><ul>
<li>ç™»å½•æ¥å£å®æ—¶è¿”å›çš„ tokenã€‚</li>
</ul><p><img src="https://static001.geekbang.org/resource/image/c4/90/c4a97041689054c34c2b721a48ecd190.png?wh=1881x695" alt="å›¾ç‰‡"></p><ul>
<li>ã€æŸ¥è¯¢æ‰€æœ‰åå°èµ„æºåˆ†ç±»ã€‘æ¥å£ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸæ›¿æ¢åˆ°å›æ”¾å“åº”çš„ tokenäº†ã€‚</li>
</ul><p><img src="https://static001.geekbang.org/resource/image/de/98/de4c63d1d179f2b5b4804e5febac1898.png?wh=750x386" alt="å›¾ç‰‡"></p><ul>
<li>ã€æŸ¥è¯¢æ‰€æœ‰åå°èµ„æºåˆ†ç±»ã€‘æ¥å£ï¼Œå›æ”¾å“åº”çš„æ•°æ®ä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚</li>
</ul><p><img src="https://static001.geekbang.org/resource/image/55/24/55b26162d5dacaa39a0a161d5f83f124.png?wh=750x321" alt="å›¾ç‰‡"></p><ul>
<li>æœåŠ¡ç«¯æ—¥å¿—æ˜¾ç¤ºæ­£å¸¸ã€‚</li>
</ul><p><img src="https://static001.geekbang.org/resource/image/71/yy/71e8fd0b45f03d5861c1debe0cd504yy.png?wh=599x348" alt="å›¾ç‰‡"></p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„åŠ¨æ€æ•°æ®å…³è”åŠŸèƒ½å°±å·²ç»å®ç°äº†ã€‚</p><h2>æ€»ç»“</h2><p>å¥½äº†ï¼Œè¿™èŠ‚è¯¾å°±è®²åˆ°è¿™é‡Œã€‚åˆšæ‰ï¼Œæˆ‘ä»¬ä¸€èµ·æ¢³ç†äº†å…³è”çš„åŸºæœ¬æ¦‚å¿µã€ GoReplay ä¸­é—´ä»¶ï¼ˆ Middleware ï¼‰åŸç†ã€å¸¸ç”¨çš„ç”¨æ³•ã€‚æˆ‘ä»¬è¿˜é€šè¿‡ä¾‹å­æ¼”ç¤ºäº†GoReplay å¦‚ä½•é€šè¿‡æ‰©å±• Middleware åšåˆ°å…³è”åŠŸèƒ½ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸­é—´ä»¶ä¸Šå®ç°ä»»ä½•è‡ªå®šä¹‰é€»è¾‘ï¼Œæ¯”å¦‚è®¤è¯ã€å¤æ‚çš„é‡å†™å’Œç­›é€‰è¯·æ±‚ç­‰ã€‚</p><p>ä¸‹ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°†è¿›å…¥å…·ä½“çš„åˆ†å¸ƒå¼æ”¹é€ ç¯èŠ‚ï¼Œæˆ‘ä¼šé€šè¿‡æ¡ˆä¾‹æ¼”ç¤ºå¦‚ä½•åšåˆ†å¸ƒå¼å¹³å°æ”¹é€ å·¥ä½œã€‚</p><h2>è¯¾åé¢˜</h2><p>å­¦å®Œè¿™èŠ‚è¯¾ï¼Œè¯·ä½ æ€è€ƒä¸¤ä¸ªé—®é¢˜ï¼š</p><ol>
<li>ä½ æœ‰æ²¡æœ‰ä½¿ç”¨è¿‡ Middlewareï¼Œè°ˆè°ˆä½ å¯¹ Middleware åº”ç”¨çš„ä¸€äº›å¿ƒå¾—å§ï¼</li>
<li>ç›¸æ¯” JMeterï¼Œä½ è§‰å¾— GoReplay å…³è”çš„éš¾åº¦åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Ÿ</li>
</ol><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºã€‚å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œä»–ä»¬çš„ä¸€äº›æƒ³æ³•æˆ–è®¸ä¼šè®©ä½ æœ‰æ›´å¤§çš„æ”¶è·ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼</p>